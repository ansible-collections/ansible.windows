---
# The existing DSC code only works for Windows PowerShell. PowerShell 7
# requires DSC v3 which is not supported by this module.
- name: check if running under Windows PowerShell
  ansible.windows.win_powershell:
    script: '$PSVersionTable.PSVersion.ToString()'
  register: ps_version

- name: Win_dsc test flow
  when: ps_version.output[0] is version('6.0', '<')
  block:
    - name: Add remote temp dir to PSModulePath
      ansible.windows.win_path:
        name: PSModulePath
        state: present
        scope: machine
        elements:
          - '{{ remote_tmp_dir }}'

    # Needed so subsequent SSH session see the new PSModulePath env var
    - name: Restart sshd service
      ansible.windows.win_service:
        name: sshd
        state: restarted
      when: ansible_connection == 'ssh'

    - name: Reset connection meta
      ansible.builtin.meta: reset_connection

    - name: Copy custom DSC resources to remote temp dir
      ansible.windows.win_copy:
        src: files/
        dest: '{{ remote_tmp_dir }}'

    - name: Run tests
      ansible.builtin.include_tasks: tests.yml

  always:
    - name: Remove remote tmp dir from PSModulePath
      ansible.windows.win_path:
        name: PSModulePath
        state: absent
        scope: machine
        elements:
          - '{{ remote_tmp_dir }}'
