---
- name: Change workgroup (check mode)
  ansible.windows.win_domain_membership:
    workgroup_name: ANSIBLETEST
    state: workgroup
    domain_admin_user: fake user
    domain_admin_password: fake password
  register: change_workgroup_check
  check_mode: true

- name: Get result of change workgroup (check mode)
  ansible.windows.win_shell: (Get-WmiObject Win32_ComputerSystem).Workgroup
  register: change_workgroup_result_check

- name: Assert result of change workgroup (check mode)
  ansible.builtin.assert:
    that:
      - change_workgroup_check is changed
      - change_workgroup_result_check.stdout == workgroup.stdout

- name: Change workgroup
  ansible.windows.win_domain_membership:
    workgroup_name: ANSIBLETEST
    state: workgroup
    domain_admin_user: fake user
    domain_admin_password: fake password
  register: change_workgroup

- name: Get result of change workgroup
  ansible.windows.win_shell: (Get-WmiObject Win32_ComputerSystem).Workgroup
  register: change_workgroup_result

- name: Assert result of change workgroup
  ansible.builtin.assert:
    that:
      - change_workgroup is changed
      - change_workgroup_result.stdout_lines[0] == "ANSIBLETEST"

- name: Change workgroup (idempotent)
  ansible.windows.win_domain_membership:
    workgroup_name: ANSIBLETEST
    state: workgroup
    domain_admin_user: fake user
    domain_admin_password: fake password
  register: change_workgroup_again

- name: Assert result of change workgroup (idempotent)
  ansible.builtin.assert:
    that:
      - change_workgroup_again is not changed

- name: Change workgroup fail invalid name
  ansible.windows.win_domain_membership:
    workgroup_name: ANSIBLELONGNAMEFAILURE
    state: workgroup
    domain_admin_user: fake user
    domain_admin_password: fake password
  register: fail_change_workgroup
  failed_when: "fail_change_workgroup.msg != 'failed to set workgroup through WMI, return value: 2695'"
