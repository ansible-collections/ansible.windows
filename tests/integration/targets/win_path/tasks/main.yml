- set_fact:
    varname: WINPATH_TEST

- name: Remove {{ varname }} vars from user and machine scope
  win_shell: '[Environment]::SetEnvironmentVariable("{{ varname }}", $null, "User"); [Environment]::SetEnvironmentVariable("{{ varname }}", $null, "Machine")'

- name: Set a var at the machine and user levels
  win_path:
    name: "{{ varname }}"
    elements: C:\{{ item }}Path
    scope: "{{ item }}"
  with_items:
  - machine
  - user
  register: pathout

- name: Get path value from machine and user levels
  win_shell: '[Environment]::GetEnvironmentVariable("{{ varname }}","{{ item.item }}")'
  with_items: "{{ pathout.results }}"
  register: varout

- name: Ensure output
  assert:
    that:
    - item.0 is changed
    - item.0.path_value == "C:\\" + item.0.item + "Path"
    - item.1.stdout_lines[0] == 'C:\\' + item.0.item + 'Path'
  with_together:
  - "{{ pathout.results }}"
  - "{{ varout.results }}"

- name: Remove {{ varname }} vars from user and machine scope
  win_shell: '[Environment]::SetEnvironmentVariable("{{ varname }}", $null, "User"); [Environment]::SetEnvironmentVariable("{{ varname }}", $null, "Machine")'

- name: Create multi-element path
  win_path:
    name: "{{ varname }}"
    elements:
    - C:\PathZ
    - C:\PathA
  register: multiout

- name: Get path value
  win_shell: (Get-Item "HKLM:\System\CurrentControlSet\Control\Session Manager\Environment").GetValue('{{ varname }}', '')
  register: varout

- name: Ensure output
  assert:
    that:
    - multiout is changed
    - multiout.path_value == "C:\\PathZ;C:\\PathA"
    - varout.stdout_lines[0] == "C:\\PathZ;C:\\PathA"

- name: Add value to middle and end
  win_path:
    name: "{{ varname }}"
    elements:
    - C:\NewPath
    - C:\PathA
    - 'C:\PathWithTrailingBackslash\' # store with a trailing backslash
    - '"C:\Quoted;With;Semicolons"' # embedded semicolon, wrapped in quotes
    - '%SystemRoot%\stuff'
  register: addout

- name: Get path value
  win_shell: (Get-Item "HKLM:\System\CurrentControlSet\Control\Session Manager\Environment").GetValue('{{ varname }}', '')
  register: varout

- name: Test idempotence- retry values to middle and end, test case-insensitive comparison, backslash canonicalization
  win_path:
    name: "{{ varname }}"
    elements:
    - c:\nEwPaTh
    - c:\patha
    - C:\pathwithtrailingbackslash # no trailing backslash, should be the same
    - '"C:\Quoted;With;Semicolons"'
    - '%SystemRoot%\stuff'
  register: idemout

- name: Get path value
  win_shell: (Get-Item "HKLM:\System\CurrentControlSet\Control\Session Manager\Environment").GetValue('{{ varname }}', '')
  register: idemvarout

- name: Ensure output
  assert:
    that:
    - addout is changed
    - addout.path_value == 'C:\\PathZ;C:\\NewPath;C:\\PathA;C:\\PathWithTrailingBackslash\\;"C:\Quoted;With;Semicolons";%SystemRoot%\stuff'
    - varout.stdout_lines[0] == ('C:\\PathZ;C:\\NewPath;C:\\PathA;C:\\PathWithTrailingBackslash\\;"C:\Quoted;With;Semicolons";C:\Windows\stuff')
    - idemout is not changed
    - idemout.path_value == 'C:\\PathZ;C:\\NewPath;C:\\PathA;C:\\PathWithTrailingBackslash\\;"C:\Quoted;With;Semicolons";%SystemRoot%\stuff'
    - idemvarout.stdout_lines[0] == ('C:\\PathZ;C:\\NewPath;C:\\PathA;C:\\PathWithTrailingBackslash\\;"C:\Quoted;With;Semicolons";C:\Windows\stuff')

- name: Remove single element
  win_path:
    name: "{{ varname }}"
    elements: C:\NewPath
    state: absent
  register: removeout

- name: Get path value
  win_shell: (Get-Item "HKLM:\System\CurrentControlSet\Control\Session Manager\Environment").GetValue('{{ varname }}', '')
  register: varout

- name: Test idempotence- retry remove single element
  win_path:
    name: "{{ varname }}"
    elements: C:\NewPath
    state: absent
  register: idemremoveout

- name: Get path value
  win_shell: (Get-Item "HKLM:\System\CurrentControlSet\Control\Session Manager\Environment").GetValue('{{ varname }}', '')
  register: idemvarout

- name: Ensure output
  assert:
    that:
    - removeout is changed
    - removeout.path_value == 'C:\\PathZ;C:\\PathA;C:\\PathWithTrailingBackslash\\;"C:\Quoted;With;Semicolons";%SystemRoot%\stuff'
    - varout.stdout_lines[0] == 'C:\\PathZ;C:\\PathA;C:\\PathWithTrailingBackslash\\;"C:\Quoted;With;Semicolons";C:\Windows\stuff'
    - idemremoveout is not changed
    - idemremoveout.path_value == 'C:\\PathZ;C:\\PathA;C:\\PathWithTrailingBackslash\\;"C:\Quoted;With;Semicolons";%SystemRoot%\stuff'
    - idemvarout.stdout_lines[0] == 'C:\\PathZ;C:\\PathA;C:\\PathWithTrailingBackslash\\;"C:\Quoted;With;Semicolons";C:\Windows\stuff'

- name: Remove multiple elements
  win_path:
    name: "{{ varname }}"
    elements:
    - C:\PathWithTrailingBackslash # no trailing backslash
    - c:\pathz
    - '"C:\Quoted;With;Semicolons"'
    - '%SystemRoot%\stuff\' # add trailing backslash
    state: absent
  register: removeout

- name: Get path value
  win_shell: (Get-Item "HKLM:\System\CurrentControlSet\Control\Session Manager\Environment").GetValue('{{ varname }}', '')
  register: varout

- name: Ensure output
  assert:
    that:
    - removeout is changed
    - removeout.path_value == "C:\\PathA"
    - varout.stdout_lines[0] == "C:\\PathA"

- name: Test check mode add
  check_mode: yes
  win_path:
    name: "{{ varname }}"
    elements:
    - C:\MissingPath
  register: checkadd

- name: Get path value
  win_shell: (Get-Item "HKLM:\System\CurrentControlSet\Control\Session Manager\Environment").GetValue('{{ varname }}', '')
  register: checkaddvarout

- name: Test check mode remove
  check_mode: yes
  win_path:
    name: "{{ varname }}"
    elements: C:\PathA
    state: absent
  register: checkremove

- name: Get path value
  win_shell: (Get-Item "HKLM:\System\CurrentControlSet\Control\Session Manager\Environment").GetValue('{{ varname }}', '')
  register: checkremovevarout

- name: Ensure output
  assert:
    that:
    - checkadd is changed
    - checkadd.path_value == "C:\\PathA;C:\\MissingPath"
    - checkaddvarout.stdout_lines[0] == "C:\\PathA" # shouldn't have actually changed the value
    - checkremove is changed
    - checkremove.path_value == ""
    - checkremovevarout.stdout_lines[0] == "C:\\PathA" # shouldn't have actually changed the value

- name: Remove {{ varname }} vars from user and machine scope
  win_shell: '[Environment]::SetEnvironmentVariable("{{ varname }}", $null, "User"); [Environment]::SetEnvironmentVariable("{{ varname }}", $null, "Machine")'

- name: Seed path before prepend tests
  win_path:
    name: "{{ varname }}"
    elements:
      - C:\PathA

- name: Test prepend single path
  win_path:
    name: "{{ varname }}"
    elements:
    - C:\PrependPath
    prepend: yes
  register: prepend_single

- name: Verify prepend single path
  win_shell: (Get-Item "HKLM:\System\CurrentControlSet\Control\Session Manager\Environment").GetValue('{{ varname }}', '')
  register: prepend_single_varout

- name: Ensure prepend single path output
  assert:
    that:
    - prepend_single is changed
    - prepend_single.path_value == "C:\PrependPath;C:\PathA"
    - prepend_single_varout.stdout_lines[0] == "C:\PrependPath;C:\PathA"

- name: Test prepend multiple paths
  win_path:
    name: "{{ varname }}"
    elements:
    - C:\PrependPath1
    - C:\PrependPath2
    prepend: yes
  register: prepend_multiple

- name: Verify prepend multiple paths
  win_shell: (Get-Item "HKLM:\System\CurrentControlSet\Control\Session Manager\Environment").GetValue('{{ varname }}', '')
  register: prepend_multiple_varout

- name: Ensure prepend multiple paths output
  assert:
    that:
    - prepend_multiple is changed
    - prepend_multiple.path_value == "C:\PrependPath1;C:\PrependPath2;C:\PrependPath;C:\PathA"
    - prepend_multiple_varout.stdout_lines[0] == "C:\PrependPath1;C:\PrependPath2;C:\PrependPath;C:\PathA"

- name: Test idempotence for prepend
  win_path:
    name: "{{ varname }}"
    elements:
    - C:\PrependPath1
    - C:\PrependPath2
    prepend: yes
  register: prepend_idempotence

- name: Ensure idempotence for prepend
  assert:
    that:
    - prepend_idempotence is not changed
    - prepend_idempotence.path_value == "C:\PrependPath1;C:\PrependPath2;C:\PrependPath;C:\PathA"

- name: Test prepend existing path
  win_path:
    name: "{{ varname }}"
    elements:
    - C:\PathA
    prepend: yes
  register: prepend_existing

- name: Verify prepend existing path
  win_shell: (Get-Item "HKLM:\System\CurrentControlSet\Control\Session Manager\Environment").GetValue('{{ varname }}', '')
  register: prepend_existing_varout

- name: Ensure prepend existing path output
  assert:
    that:
    - prepend_existing is changed
    - prepend_existing.path_value == "C:\PathA;C:\PrependPath1;C:\PrependPath2;C:\PrependPath"
    - prepend_existing_varout.stdout_lines[0] == "C:\PathA;C:\PrependPath1;C:\PrependPath2;C:\PrependPath"

- name: Test check mode for prepend
  check_mode: yes
  win_path:
    name: "{{ varname }}"
    elements:
    - C:\CheckModePath
    prepend: yes
  register: check_prepend

- name: Verify check mode for prepend
  win_shell: (Get-Item "HKLM:\System\CurrentControlSet\Control\Session Manager\Environment").GetValue('{{ varname }}', '')
  register: check_prepend_varout

- name: Ensure check mode for prepend output
  assert:
    that:
    - check_prepend is changed
    - check_prepend.path_value == "C:\CheckModePath;C:\PathA;C:\PrependPath1;C:\PrependPath2;C:\PrependPath"
    - check_prepend_varout.stdout_lines[0] == "C:\PathA;C:\PrependPath1;C:\PrependPath2;C:\PrependPath" # shouldn't have actually changed the value

- name: Remove {{ varname }} vars from user and machine scope
  win_shell: '[Environment]::SetEnvironmentVariable("{{ varname }}", $null, "User"); [Environment]::SetEnvironmentVariable("{{ varname }}", $null, "Machine")'
